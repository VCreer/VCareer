@startuml Leader Recruiter Performance Dashboard - Sequence Diagram

' ====================
' TITLE & STYLE
' ====================
title Leader Recruiter Performance Dashboard - Sequence Diagram\nGet Company Dashboard Flow

skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 200
skinparam sequenceParticipant underline

' ====================
' ACTORS & PARTICIPANTS
' ====================
actor "Leader Recruiter" as Leader
participant "Browser" as Browser
participant "Angular Component" as Component
participant "Dashboard Service" as NgService
participant "API Controller" as Controller
participant "Dashboard AppService" as Service
participant "Activity Log Repository" as ActivityRepo
participant "Recruiter Repository" as RecruiterRepo
participant "User Repository" as UserRepo
database "Database" as DB

' ====================
' MAIN FLOW
' ====================

== Initialization ==

Leader -> Browser : Navigate to /recruiter/performance-dashboard
activate Browser

Browser -> Component : ngOnInit()
activate Component

Component -> Component : Initialize filter with default values\n(last 30 days, sortBy: ThisMonthActivities)

Component -> NgService : getCompanyDashboard(filter)
activate NgService

NgService -> Controller : GET /api/app/recruitment-dashboard/company\n+ query params (startDate, endDate, sortBy, etc.)
activate Controller

== Authorization Check ==

Controller -> Service : GetCompanyDashboardAsync(filter)
activate Service

Service -> Service : GetCurrentRecruiterProfileAsync()
activate Service

Service -> RecruiterRepo : FirstOrDefaultAsync(r => r.UserId == currentUserId)\n.Include(r => r.User)\n.Include(r => r.Company)
activate RecruiterRepo

RecruiterRepo -> DB : SELECT * FROM RecruiterProfile\nWHERE UserId = @currentUserId
activate DB
DB --> RecruiterRepo : RecruiterProfile data
deactivate DB

RecruiterRepo --> Service : RecruiterProfile
deactivate RecruiterRepo

alt Recruiter Not Found
    Service --> Controller : throw UserFriendlyException("You are not a Recruiter")
    Controller --> NgService : 403 Forbidden
    NgService --> Component : Error
    Component --> Browser : Display error message
    Browser --> Leader : Show "Access Denied"
    [<-- Leader
    destroy Leader
else Recruiter Not Lead
    Service --> Controller : throw UserFriendlyException("Only Leader Recruiters can access")
    Controller --> NgService : 403 Forbidden
    NgService --> Component : Error
    Component --> Browser : Display error message
    Browser --> Leader : Show "Insufficient Permissions"
    [<-- Leader
    destroy Leader
end

deactivate Service

== Fetch All Staff in Company ==

Service -> RecruiterRepo : WithDetailsAsync(r => r.User)\nWhere(r => r.CompanyId == companyId)
activate RecruiterRepo

RecruiterRepo -> DB : SELECT * FROM RecruiterProfile rp\nJOIN IdentityUser u ON rp.UserId = u.Id\nWHERE rp.CompanyId = @companyId
activate DB
DB --> RecruiterRepo : List of Staff
deactivate DB

RecruiterRepo --> Service : List<RecruiterProfile>
deactivate RecruiterRepo

note right of Service
  Filter staff based on:
  - IncludeInactive flag
  - Specific StaffId (if provided)
end note

== Fetch Activity Logs ==

Service -> ActivityRepo : Where(a => staffIds.Contains(a.UserId))\n.Where(a => a.CreationTime >= startDate)\n.Where(a => a.CreationTime <= endDate)
activate ActivityRepo

ActivityRepo -> DB : SELECT * FROM ActivityLogs\nWHERE UserId IN (@staffIds)\nAND CreationTime BETWEEN @startDate AND @endDate
activate DB
DB --> ActivityRepo : List of ActivityLog
deactivate DB

ActivityRepo --> Service : List<ActivityLog>
deactivate ActivityRepo

== Calculate Performance for Each Staff ==

loop For each staff in company
    Service -> Service : CalculateStaffPerformance(staff, staffActivities, filter)
    activate Service
    
    note right of Service
      Calculate metrics:
      1. Count activities by type
         - JobPosted, JobClosed, etc.
      2. Calculate rates
         - Approval Rate = Approved / (Approved + Rejected)
         - Interview Completion Rate
      3. Time-based statistics
         - Today, This Week, This Month
      4. Average activities per day
      5. Find last activity
    end note
    
    Service --> Service : StaffPerformanceDto
    deactivate Service
end

== Sort Staff Performances ==

Service -> Service : SortStaffPerformances(staffPerformances, sortBy, descending)
activate Service

note right of Service
  Sort by selected criteria:
  - FullName
  - TotalActivities
  - ApprovalRate
  - JobsPosted
  - CandidatesApproved
  - InterviewsCompleted
end note

Service --> Service : Sorted List<StaffPerformanceDto>
deactivate Service

== Calculate Aggregated Company Statistics ==

Service -> Service : Calculate Company Dashboard
activate Service

note right of Service
  Aggregate statistics:
  1. Sum all staff statistics
     - Total Jobs Posted
     - Total Candidates Approved
     - Total Interviews Completed
  2. Calculate company-wide rates
     - Overall Approval Rate
     - Overall Interview Completion Rate
  3. Calculate averages
     - Average Activities Per Staff
end note

Service --> Service : CompanyDashboardDto (partial)
deactivate Service

== Calculate Top Performers ==

Service -> Service : CalculateTopPerformers(staffPerformances)
activate Service

note right of Service
  Identify top performers in categories:
  1. Most Jobs Posted
  2. Most Candidates Approved
  3. Most Interviews Completed
  4. Highest Approval Rate (min 5 evaluations)
  5. Most Active This Month
end note

Service --> Service : List<TopPerformerDto>
deactivate Service

== Return Response ==

Service --> Controller : CompanyDashboardDto
deactivate Service

Controller --> NgService : 200 OK + CompanyDashboardDto (JSON)
deactivate Controller

NgService --> Component : Observable<CompanyDashboardDto>
deactivate NgService

Component -> Component : Update companyDashboard property
Component -> Component : Set loading = false

Component --> Browser : Render dashboard UI
deactivate Component

Browser --> Leader : Display Dashboard with:\n- Summary cards\n- Staff performance table\n- Top performers\n- Activity statistics
deactivate Browser

== Load Activity Trend (Parallel) ==

Component -> NgService : getActivityTrend(filter)
activate Component
activate NgService

NgService -> Controller : GET /api/app/recruitment-dashboard/trend
activate Controller

Controller -> Service : GetActivityTrendAsync(filter)
activate Service

note right of Service
  Group activities by:
  1. Daily (last 30 days)
  2. Weekly
  3. Monthly
end note

Service -> ActivityRepo : Get filtered activities
activate ActivityRepo
ActivityRepo -> DB : Query activities
activate DB
DB --> ActivityRepo : Activities
deactivate DB
ActivityRepo --> Service : List<ActivityLog>
deactivate ActivityRepo

Service -> Service : Group activities by date\nCalculate counts\nFormat labels

Service --> Controller : ActivityTrendDto
deactivate Service

Controller --> NgService : 200 OK + ActivityTrendDto
deactivate Controller

NgService --> Component : Observable<ActivityTrendDto>
deactivate NgService

Component -> Component : Update activityTrend property

Component --> Browser : Render trend chart
deactivate Component

== User Interactions ==

alt User applies filters
    Leader -> Browser : Change filter values\n(startDate, endDate, sortBy)
    Browser -> Component : applyFilters()
    Component -> NgService : getCompanyDashboard(newFilter)
    note right : Repeat main flow with new filter
    
else User views staff detail
    Leader -> Browser : Click on staff row
    Browser -> Component : getStaffPerformanceAsync(staffId, filter)
    Component -> NgService : getStaffPerformance(staffId, filter)
    NgService -> Controller : GET /api/app/recruitment-dashboard/staff/{staffId}
    Controller -> Service : GetStaffPerformanceAsync(staffId, filter)
    note right of Service
      1. Verify staff is in same company
      2. Get staff activities
      3. Calculate performance
    end note
    Service --> Controller : StaffPerformanceDto
    Controller --> NgService : 200 OK + StaffPerformanceDto
    NgService --> Component : Observable<StaffPerformanceDto>
    Component --> Browser : Display detailed performance
    
else User exports to CSV
    Leader -> Browser : Click "Export CSV"
    Browser -> Component : exportToCSV()
    Component -> Component : Generate CSV from companyDashboard.staffPerformances
    Component -> Browser : Download CSV file
    Browser --> Leader : Save file to disk
    
else User compares staff
    Leader -> Browser : Select multiple staff\nClick compare
    Browser -> Component : compareStaffPerformanceAsync(selectedStaffIds, filter)
    Component -> NgService : compareStaffPerformance(staffIds, filter)
    NgService -> Controller : POST /api/app/recruitment-dashboard/compare
    Controller -> Service : CompareStaffPerformanceAsync(staffIds, filter)
    
    loop For each staffId
        Service -> Service : GetStaffPerformanceAsync(staffId, filter)
        note right : Reuse existing method
    end
    
    Service --> Controller : StaffPerformanceDto[]
    Controller --> NgService : 200 OK + StaffPerformanceDto[]
    NgService --> Component : Observable<StaffPerformanceDto[]>
    Component --> Browser : Display comparison view
end

Leader -> Browser : Continue using dashboard

note over Leader, DB
  **Security Notes:**
  - Only authenticated users can access
  - Only Leader Recruiters (IsLead = true) have permission
  - Data is isolated by company
  - Can only view staff in same company
end note

@enduml





