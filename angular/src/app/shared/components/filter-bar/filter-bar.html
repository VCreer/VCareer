<div class="filter-bar-container">
  <!-- ‚úÖ LAYOUT: Category (tr√°i) | Search (gi·ªØa) | Location & Search Button (ph·∫£i) -->

  <!-- 1. Category dropdown (b√™n tr√°i) -->
  <button
    class="filter-trigger-btn category-btn"
    (click)="toggleCategoryDropdown()"
    [class.active]="showCategoryDropdown"
  >
    <span class="filter-icon">‚ò∞</span>
    <span class="filter-label">Danh m·ª•c Ngh·ªÅ{{ getCategoryCountText() }}</span>
    <span class="dropdown-arrow" [class.open]="showCategoryDropdown">‚ñº</span>
  </button>

  <!-- 2. Search input wrapper (·ªü gi·ªØa, flex-grow) -->
  <div class="search-input-wrapper">
    <ng-content select="[search-input]"></ng-content>
  </div>

  <!-- 3. Location dropdown (b√™n ph·∫£i, c·∫°nh n√∫t search) -->
  <button
    class="filter-trigger-btn location-btn"
    (click)="toggleLocationDropdown()"
    [class.active]="showLocationDropdown"
  >
    <span class="filter-label">ƒê·ªãa ƒëi·ªÉm{{ getLocationCountText() }}</span>
    <span class="dropdown-arrow" [class.open]="showLocationDropdown">‚ñº</span>
  </button>

  <!-- 4. Search button s·∫Ω ƒë∆∞·ª£c pass t·ª´ parent -->
  <ng-content select="[search-button]"></ng-content>

  <!-- ============================================ -->
  <!-- CATEGORY DROPDOWN (3 c·∫•p v·ªõi hover) -->
  <!-- ============================================ -->
  <div class="filter-dropdown category-dropdown" *ngIf="showCategoryDropdown">
    <!-- Header -->
    <div class="dropdown-header">
      <h3 class="dropdown-title">Ch·ªçn Nh√≥m ngh·ªÅ, Ngh·ªÅ ho·∫∑c Chuy√™n m√¥n</h3>
      <button class="close-btn" (click)="closeDropdowns()">‚úï</button>
    </div>

    <!-- Search Input -->
    <div class="search-box">
      <input
        type="text"
        class="search-input"
        placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm"
        [(ngModel)]="categorySearchKeyword"
        (input)="onCategorySearch()"
      />
      <span class="search-icon">üîç</span>
    </div>

    <!-- Content: 2 c·ªôt -->
    <div class="dropdown-content">
      <!-- ‚úÖ N·∫øu ƒëang search ‚Üí Hi·ªÉn th·ªã flat list -->
      <div class="search-results-view" *ngIf="isSearching()">
        <!-- ‚úÖ C√≥ k·∫øt qu·∫£ -->
        <div *ngIf="hasSearchResults">
          <div class="results-header">V·ªä TR√ç CHUY√äN M√îN ({{ searchResults.length }} k·∫øt qu·∫£)</div>
          <div class="results-list">
            <div
              *ngFor="let result of searchResults"
              class="search-result-item"
              [class.selected]="isCategorySelected(result.categoryId)"
            >
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="isCategorySelected(result.categoryId)"
                  (change)="toggleCategorySelection(result.categoryId, $event)"
                />
                <div class="result-content">
                  <span class="result-name">{{ result.categoryName }}</span>
                  <span class="result-path">{{ result.fullPath }}</span>
                  <span class="job-count">({{ result.jobCount }} vi·ªác)</span>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- ‚úÖ Kh√¥ng c√≥ k·∫øt qu·∫£ -->
        <div *ngIf="!hasSearchResults" class="no-results">
          <p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</p>
        </div>
      </div>

      <!-- ‚úÖ N·∫øu KH√îNG search ‚Üí Hi·ªÉn th·ªã tree b√¨nh th∆∞·ªùng -->
      <!-- ‚ö†Ô∏è PH·∫¢I D√ôNG DIV thay v√¨ ng-container v√¨ CSS Grid! -->
      <div class="category-tree-view" *ngIf="!isSearching()">
        <!-- DEBUG INFO -->
        <div
          *ngIf="filteredCategories.length === 0"
          style="padding: 20px; color: #999; grid-column: 1 / -1"
        >
          Kh√¥ng c√≥ d·ªØ li·ªáu (filteredCategories.length = {{ filteredCategories.length }})
        </div>

        <!-- C·ªòT TR√ÅI: Danh s√°ch Category c·∫•p 1 -->
        <div class="category-level1-list" *ngIf="filteredCategories.length > 0">
          <div class="list-header">NH√ìM NGH·ªÄ ({{ filteredCategories.length }})</div>
          <div class="scrollable-list">
            <div
              *ngFor="let category of filteredCategories"
              class="category-item level1-item"
              [class.selected]="isCategorySelected(category.categoryId)"
              [class.hovered]="hoveredLevel1Category?.categoryId === category.categoryId"
              (mouseenter)="onCategoryLevel1Hover(category)"
            >
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="isCategorySelected(category.categoryId)"
                  (change)="toggleCategorySelection(category.categoryId, $event)"
                />
                <span class="category-name">{{ category.categoryName }}</span>
                <span class="job-count">({{ category.jobCount }})</span>
                <span class="arrow-right" *ngIf="category.children && category.children.length > 0"
                  >‚Ä∫</span
                >
              </label>
            </div>
          </div>
        </div>

        <!-- C·ªòT PH·∫¢I: C·∫•p 2 (NGH·ªÄ) v√† C·∫•p 3 (V·ªä TR√ç CHUY√äN M√îN) -->
        <div class="category-level23-panel" *ngIf="hoveredLevel1Category">
          <!-- C·∫•p 2: NGH·ªÄ -->
          <div
            class="level2-section"
            *ngIf="hoveredLevel1Category.children && hoveredLevel1Category.children.length > 0"
          >
            <div class="section-header">NGH·ªÄ</div>
            <div class="level2-list">
              <div
                *ngFor="let level2 of hoveredLevel1Category.children"
                class="category-item level2-item"
              >
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="isCategorySelected(level2.categoryId)"
                    (change)="toggleCategorySelection(level2.categoryId, $event)"
                  />
                  <span class="category-name">{{ level2.categoryName }}</span>
                  <span class="job-count" *ngIf="level2.jobCount > 0">({{ level2.jobCount }})</span>
                </label>

                <!-- C·∫•p 3: V·ªä TR√ç CHUY√äN M√îN (tags) -->
                <div class="level3-tags" *ngIf="level2.children && level2.children.length > 0">
                  <div class="section-header small">V·ªä TR√ç CHUY√äN M√îN</div>
                  <div class="tags-container">
                    <label
                      *ngFor="let level3 of level2.children"
                      class="tag-label"
                      [class.selected]="isCategorySelected(level3.categoryId)"
                    >
                      <input
                        type="checkbox"
                        [checked]="isCategorySelected(level3.categoryId)"
                        (change)="toggleCategorySelection(level3.categoryId, $event)"
                        style="display: none"
                      />
                      <span class="tag-text">{{ level3.categoryName }}</span>
                      <span class="tag-count" *ngIf="level3.jobCount > 0"
                        >({{ level3.jobCount }})</span
                      >
                    </label>
                  </div>
                </div>
              </div>
            </div>
      </div>
      </div>
      </div>
    </div>
    
    <!-- Footer Actions -->
    <div class="dropdown-footer">
      <button class="btn-text" (click)="clearAllCategories()">B·ªè ch·ªçn t·∫•t c·∫£</button>
      <button class="btn-primary" (click)="applyCategoryFilter()">Ch·ªçn</button>
      </div>
      <div class="filter-option" [class.active]="selectedFilter==='M·ª©c l∆∞∆°ng'" (click)="selectFilter('M·ª©c l∆∞∆°ng')">
        {{ translate('filter.salary') || 'M·ª©c l∆∞∆°ng' }}
        <span class="checkmark" *ngIf="selectedFilter==='M·ª©c l∆∞∆°ng'">‚úì</span>
      </div>

  <!-- ‚úÖ B·ªé OVERLAY (kh√¥ng l√†m m·ªù background) -->
      </div>

<!-- ============================================ -->
<!-- LOCATION DROPDOWN - RI√äNG BI·ªÜT, KH√îNG D√ôNG CLASS CATEGORY -->
<!-- ============================================ -->
<div class="location-dropdown-wrapper" *ngIf="showLocationDropdown">
  <div class="location-dropdown-container">
    <!-- Header -->
    <div class="location-header">
      <h3 class="location-title">Ch·ªçn ƒê·ªãa ƒëi·ªÉm</h3>
      <button class="location-close-btn" (click)="closeDropdowns()">‚úï</button>
      </div>

    <!-- Search Input -->
    <div class="location-search-box">
      <input
        type="text"
        class="location-search-input"
        placeholder="Nh·∫≠p t·ªânh/th√†nh ph·ªë ho·∫∑c qu·∫≠n/huy·ªán"
        [(ngModel)]="locationSearchKeyword"
        (input)="onLocationSearch()"
      />
      <span class="location-search-icon">üîç</span>
    </div>

    <!-- Content: 2 c·ªôt -->
    <div class="location-content">
      <div class="location-grid">
        <!-- Empty state (full width khi kh√¥ng c√≥ d·ªØ li·ªáu) -->
        <div *ngIf="filteredProvinces.length === 0" class="location-empty">
          <span *ngIf="locationSearchKeyword.trim().length > 0">Kh√¥ng c√≥ k·∫øt qu·∫£</span>
          <span *ngIf="locationSearchKeyword.trim().length === 0">Kh√¥ng c√≥ ƒë·ªãa ƒëi·ªÉm</span>
  </div>

        <!-- C·ªòT TR√ÅI: Provinces -->
        <div class="location-provinces" *ngIf="filteredProvinces.length > 0">
          <div class="location-list-header">T·ªàNH/TH√ÄNH PH·ªê ({{ filteredProvinces.length }})</div>
          <div class="location-scrollable">
            <div
              *ngFor="let province of filteredProvinces"
              class="location-province-item"
              [class.selected]="isProvinceSelected(province.id)"
              [class.hovered]="hoveredProvince?.id === province.id"
              (mouseenter)="onProvinceHover(province)"
            >
              <label class="location-checkbox-label">
                <input
                  type="checkbox"
                  [checked]="isProvinceSelected(province.id)"
                  (change)="toggleProvinceSelection(province.id, $event)"
                />
                <span class="location-name">{{ province.name }}</span>
                <span
                  class="location-count"
                  *ngIf="province.districts && province.districts.length > 0"
                >
                  ({{ province.districts.length }})
                </span>
                <span
                  class="location-arrow"
                  *ngIf="province.districts && province.districts.length > 0"
                  >‚Ä∫</span
                >
              </label>
            </div>
          </div>
        </div>
    
        <!-- C·ªòT PH·∫¢I: Districts (lu√¥n hi·ªÉn th·ªã, c√≥ fixed height) -->
        <div class="location-districts" *ngIf="filteredProvinces.length > 0">
          <!-- C√≥ province ƒë∆∞·ª£c hover v√† c√≥ districts -->
          <div
            class="location-district-wrapper"
            *ngIf="hoveredProvince && hoveredProvince.districts && hoveredProvince.districts.length > 0"
          >
            <div class="location-list-header">QU·∫¨N/HUY·ªÜN - {{ hoveredProvince.name }}</div>
            <div class="location-scrollable">
      <div 
                *ngFor="let district of hoveredProvince.districts"
                class="location-district-item"
                [class.selected]="isDistrictSelected(district.id)"
      >
                <label class="location-checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="isDistrictSelected(district.id)"
                    (change)="toggleDistrictSelection(hoveredProvince.id, district.id, $event)"
                  />
                  <span class="location-name">{{ district.name }}</span>
                </label>
              </div>
      </div>
    </div>
    
          <!-- Empty state: Ch∆∞a hover ho·∫∑c province kh√¥ng c√≥ districts -->
          <div
            *ngIf="!hoveredProvince || !hoveredProvince.districts || hoveredProvince.districts.length === 0"
            class="location-districts-empty"
          >
            <p *ngIf="!hoveredProvince">Vui l√≤ng ch·ªçn T·ªânh/Th√†nh ph·ªë</p>
            <p
              *ngIf="hoveredProvince && (!hoveredProvince.districts || hoveredProvince.districts.length === 0)"
            >
              {{ hoveredProvince.name }} kh√¥ng c√≥ qu·∫≠n/huy·ªán
            </p>
          </div>
        </div>
      </div>
  </div>

    <!-- Footer Actions -->
    <div class="location-footer">
      <button class="location-btn-clear" (click)="clearAllLocations()">B·ªè ch·ªçn t·∫•t c·∫£</button>
      <button class="location-btn-apply" (click)="applyLocationFilter()">√Åp d·ª•ng</button>
  </div>
  </div>
</div>
