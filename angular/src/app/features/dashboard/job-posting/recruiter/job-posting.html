<div class="job-posting-page" [class.sidebar-expanded]="sidebarExpanded">
  <!-- Toast Notification -->
  <app-toast-notification
    [show]="showToast"
    [message]="toastMessage"
    [type]="toastType"
    (close)="onToastClose()"
  >
  </app-toast-notification>

  <!-- Breadcrumb Box -->
  <div class="breadcrumb-box" [class.sidebar-expanded]="sidebarExpanded">
    <div class="breadcrumb-container">
      <div class="page-header">
        <h1 class="page-title">Đăng tin tuyển dụng</h1>
        <span class="campaign-badge" *ngIf="campaignName"> Chiến dịch: {{ campaignName }} </span>
      </div>
      <div class="action-buttons">
        <app-button type="secondary" size="small" (click)="openPreviewModal()">
          Xem trước
        </app-button>
        <app-button type="primary" size="small" (click)="onSaveOrUpdateJob()">
          {{ getSubmitButtonText() }}
        </app-button>
      </div>
    </div>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Form -->
    <div class="form-wrapper">
      <h2 class="form-main-title">Thông tin công việc</h2>

      <!-- Job Title Section -->
      <div class="form-section">
        <h3 class="section-title">Tên Công việc</h3>

        <!-- Job Title -->
        <app-input-field
          label="Tên công việc"
          type="text"
          placeholder="Nhập tên công việc"
          [required]="true"
          [error]="getFieldError('jobTitle')"
          [(ngModel)]="jobForm.jobTitle"
          (ngModelChange)="onFieldChange('jobTitle')"
          name="jobTitle"
        >
        </app-input-field>

        <div class="geo-select-group">
          <!-- Province -->
          <app-select-field
            label="Tỉnh / Thành phố"
            placeholder="Chọn tỉnh / thành phố"
            [required]="true"
            [options]="provinceOptions"
            [error]="getFieldError('provinceCode')"
            [(ngModel)]="selectedProvince"
            (ngModelChange)="onProvinceChange($event)"
            name="provinceCode"
          ></app-select-field>

          <!-- Ward -->
          <app-select-field
            label="Phường / Xã"
            placeholder="Chọn phường / xã"
            [required]="true"
            [disabled]="!selectedProvince"
            [options]="wardOptions"
            [error]="getFieldError('wardCode')"
            [(ngModel)]="selectedWard"
            name="wardCode"
          ></app-select-field>
        </div>

        <!-- lương -->
        <label class="toggle-wrap">
          <input
            type="checkbox"
            [(ngModel)]="salaryDeal"
            (ngModelChange)="onToggleSalaryDeal($event)"
          />
          <span class="toggle-slider"></span>
          <span class="toggle-label">Lương thỏa thuận</span>
        </label>

        <div class="salary-range-wrapper">
          <label class="salary-label">Mức lương (VNĐ)</label>

          <div class="salary-display-box" *ngIf="!salaryDeal">
            <div class="salary-item">
              <span class="salary-title">Tối thiểu</span>
              <span class="salary-value">
                {{ salaryMin | number:'1.0-0' }} ({{ formatSalary(salaryMin) }})
              </span>
            </div>
            <div class="salary-item">
              <span class="salary-title">Tối đa</span>
              <span class="salary-value">
                {{ salaryMax | number:'1.0-0' }} ({{ formatSalary(salaryMax) }})
              </span>
            </div>
          </div>

          <div class="salary-display-box" *ngIf="salaryDeal">
            <span style="font-weight: 600">Lương thỏa thuận</span>
          </div>

          <div class="salary-range-container">
            <div class="track"></div>

            <div
              class="range-highlight"
              *ngIf="!salaryDeal"
              [ngStyle]="{
                left: (salaryMin / 500000000 * 100) + '%',
                width: ((salaryMax - salaryMin) / 500000000 * 100) + '%'
              }"
            ></div>

            <input
              type="range"
              min="100000"
              max="500000000"
              step="100000"
              [(ngModel)]="salaryMin"
              (input)="onSalaryChange()"
              class="range-input"
              [disabled]="salaryDeal"
            />

            <input
              type="range"
              min="100000"
              max="500000000"
              step="100000"
              [(ngModel)]="salaryMax"
              (input)="onSalaryChange()"
              class="range-input"
              [disabled]="salaryDeal"
            />
          </div>

          <div class="error-message" *ngIf="getFieldError('salary')">
            {{ getFieldError('salary') }}
          </div>
        </div>

        <!-- Experience -->
        <app-select-field
          label="Kinh nghiệm"
          placeholder="Chọn kinh nghiệm"
          [required]="true"
          [options]="experienceOptions"
          [error]="getFieldError('experience')"
          [(ngModel)]="jobForm.experience"
          (ngModelChange)="onFieldChange('experience')"
          name="experience"
        >
        </app-select-field>

        <!-- Application Deadline - Native Input với min và max -->
        <div class="input-field-wrapper">
          <label class="input-label">
            Hạn nộp hồ sơ
            <span class="required-mark">*</span>
          </label>
          <input
            type="date"
            class="date-input"
            [class.has-error]="getFieldError('applicationDeadline')"
            [min]="getMinApplicationDeadline()"
            [max]="getMaxApplicationDeadline()"
            [(ngModel)]="jobForm.applicationDeadline"
            (ngModelChange)="onFieldChange('applicationDeadline')"
            name="applicationDeadline"
          />
          <div class="input-hint">Từ 7 ngày đến 2 tháng kể từ hôm nay</div>
          <div class="error-message" *ngIf="getFieldError('applicationDeadline')">
            {{ getFieldError('applicationDeadline') }}
          </div>
        </div>
      </div>

      <!-- General Information Section -->
      <div class="form-section">
        <h3 class="section-title">Thông tin chung</h3>

        <!-- Position Level -->
        <app-select-field
          label="Cấp bậc"
          placeholder="Chọn cấp bậc"
          [required]="true"
          [options]="positionLevelOptions"
          [error]="getFieldError('positionLevel')"
          [(ngModel)]="jobForm.positionLevel"
          (ngModelChange)="onFieldChange('positionLevel')"
          name="positionLevel"
        >
        </app-select-field>

        <!-- Quantity -->
        <app-input-field
          label="Số lượng tuyển"
          type="number"
          placeholder="Nhập số lượng tuyển"
          [required]="true"
          [error]="getFieldError('quantity')"
          [(ngModel)]="jobForm.quantity"
          (ngModelChange)="onFieldChange('quantity')"
          name="quantity"
        >
        </app-input-field>

        <!-- Employment Type -->
        <app-select-field
          label="Hình thức làm việc"
          placeholder="Chọn hình thức làm việc"
          [required]="true"
          [options]="employmentTypeOptions"
          [error]="getFieldError('employmentType')"
          [(ngModel)]="jobForm.employmentType"
          (ngModelChange)="onFieldChange('employmentType')"
          name="employmentType"
        >
        </app-select-field>
      </div>

      <!-- Job Description Section -->
      <div class="form-section">
        <h3 class="section-title">Mô tả công việc</h3>

        <app-rich-text-editor
          label="Mô tả công việc"
          placeholder="Nhập mô tả chi tiết về công việc..."
          [required]="true"
          [(ngModel)]="jobForm.description"
          (ngModelChange)="onFieldChange('description')"
          name="description"
        >
        </app-rich-text-editor>
        <div class="error-message" *ngIf="getFieldError('description')">
          {{ getFieldError('description') }}
        </div>
      </div>

      <!-- Requirements Section -->
      <div class="form-section">
        <h3 class="section-title">Yêu cầu ứng viên</h3>

        <app-rich-text-editor
          label="Yêu cầu ứng viên"
          placeholder="Nhập các yêu cầu đối với ứng viên..."
          [required]="true"
          [(ngModel)]="jobForm.requirements"
          (ngModelChange)="onFieldChange('requirements')"
          name="requirements"
        >
        </app-rich-text-editor>
        <div class="error-message" *ngIf="getFieldError('requirements')">
          {{ getFieldError('requirements') }}
        </div>
      </div>

      <!-- Benefits Section -->
      <div class="form-section">
        <h3 class="section-title">Quyền lợi</h3>

        <app-rich-text-editor
          label="Quyền lợi"
          placeholder="Nhập các quyền lợi mà ứng viên sẽ nhận được..."
          [required]="true"
          [(ngModel)]="jobForm.benefits"
          (ngModelChange)="onFieldChange('benefits')"
          name="benefits"
        >
        </app-rich-text-editor>
        <div class="error-message" *ngIf="getFieldError('benefits')">
          {{ getFieldError('benefits') }}
        </div>
      </div>

      <!-- Category Section -->
      <div class="form-section">
        <h3 class="section-title">
          Ngành nghề
          <span class="required-mark">*</span>
        </h3>

        <div class="category-dropdowns">
          <app-select-field
            label="Ngành nghề chính"
            placeholder="Chọn ngành nghề chính"
            [required]="true"
            [options]="parentCategoryOptions"
            [error]="getFieldError('parentCategory')"
            [(ngModel)]="selectedParentId"
            (ngModelChange)="onParentCategoryChange($event)"
            name="parentCategory"
          ></app-select-field>

          <app-select-field
            label="Lĩnh vực cụ thể"
            placeholder="Chọn lĩnh vực cụ thể"
            [required]="true"
            [disabled]="!selectedParentId"
            [options]="childCategoryOptions"
            [error]="getFieldError('jobCategoryId')"
            [(ngModel)]="selectedCategoryId"
            (ngModelChange)="onChildCategoryChange($event)"
            name="jobCategoryId"
          ></app-select-field>
        </div>
      </div>

      <!-- Tags Section -->
      <div class="form-section" *ngIf="selectedCategoryId && availableTags.length > 0">
        <h3 class="section-title">
          Từ khóa tuyển dụng
          <span class="optional-mark">(Tùy chọn)</span>
        </h3>

        <div class="tags-selector">
          <div class="selected-tags-area" *ngIf="selectedTags.length > 0">
            <div class="selected-tags-header">
              <span class="tags-count">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M13.3 4.7l-6.6 6.6-3.4-3.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Đã chọn {{ selectedTags.length }} từ khóa
              </span>
              <button type="button" class="clear-all-btn" (click)="clearAllTags()">
                Xóa tất cả
              </button>
            </div>
            <div class="selected-tags-chips">
              <div *ngFor="let tag of selectedTags" class="tag-chip selected">
                <span>{{ tag.name }}</span>
                <button type="button" (click)="toggleTag(tag)">
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M9 3L3 9M3 3l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="available-tags-area">
            <p class="area-label">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              Click để chọn từ khóa:
            </p>
            <div class="tags-chips-grid">
              <button
                type="button"
                *ngFor="let tag of availableTags"
                class="tag-chip"
                [class.selected]="isTagSelected(tag)"
                (click)="toggleTag(tag)"
              >
                {{ tag.name }}
              </button>
            </div>
          </div>

          <div class="tags-helper">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 7v4M8 5h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <span>Chọn các từ khóa phù hợp để tăng khả năng tiếp cận ứng viên</span>
          </div>
        </div>
      </div>

      <!-- Work Location Section -->
      <div class="form-section">
        <h3 class="section-title">Địa điểm làm việc</h3>

        <app-input-field
          label="Địa điểm làm việc"
          type="text"
          placeholder="Nhập địa điểm làm việc cụ thể"
          [required]="true"
          [error]="getFieldError('workLocation')"
          [(ngModel)]="jobForm.workLocation"
          (ngModelChange)="onFieldChange('workLocation')"
          name="workLocation"
        >
        </app-input-field>

        <app-input-field
          label="Thời gian làm việc"
          type="text"
          placeholder="Nhập thời gian làm việc cụ thể"
          [required]="true"
          [error]="getFieldError('workTime')"
          [(ngModel)]="jobForm.workTime"
          (ngModelChange)="onFieldChange('workTime')"
          name="workTime"
        >
        </app-input-field>
      </div>

      <!-- Preview Modal -->
      <app-generic-modal
        [show]="showPreviewModal"
        title="Xem trước"
        maxWidth="1400px"
        bodyBackground="#f8fafc"
        (close)="closePreviewModal()"
      >
        <app-job-preview [jobData]="jobForm"></app-job-preview>
      </app-generic-modal>
    </div>
  </div>
</div>