<div class="recruitment-campaign-container" [class.sidebar-expanded]="sidebarExpanded">
  <!-- Toast -->
  <app-toast-notification
    [show]="showToast"
    [message]="toastMessage"
    [type]="toastType"
    (close)="showToast = false"
  >
  </app-toast-notification>

  <!-- Breadcrumb -->
  <div class="breadcrumb-box" [class.sidebar-expanded]="sidebarExpanded">
    <div class="breadcrumb-container">
      <span class="breadcrumb-item active">
        {{ viewMode === 'manage' ? 'Quản lý chiến dịch tuyển dụng' : 'Tạo chiến dịch tuyển dụng' }}
      </span>
      <app-button
        *ngIf="viewMode === 'manage'"
        type="primary"
        size="medium"
        (click)="onCreateNewCampaign()"
      >
        <i class="fa fa-plus"></i> Thêm chiến dịch mới
      </app-button>
    </div>
  </div>

  <!-- CREATE VIEW -->
  <div class="main-content" *ngIf="viewMode === 'create'">
    <div class="campaign-form-section">
      <h1 class="form-title">Tạo chiến dịch tuyển dụng</h1>

      <form class="campaign-form" (ngSubmit)="onNext()">
        <!-- Tên chiến dịch -->
        <div class="form-row">
          <div class="form-group">
            <app-input-field
              label="Tên chiến dịch tuyển dụng"
              type="text"
              placeholder="VD: Tuyển dụng Marketing Q4/2025, Designer Full-time..."
              [required]="true"
              [error]="getFieldError('campaignName')"
              [(ngModel)]="campaignForm.campaignName"
              name="campaignName"
              autofocus
            >
            </app-input-field>
          </div>
        </div>

        <!-- 2 NÚT ĐẸP LUNG LINH, KHÔNG DÙNG app-button ĐỂ TRÁNH LỖI -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="viewMode = 'manage'">
            <i class="fa fa-arrow-left"></i> Quay lại
          </button>

          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isCreating || !campaignForm.campaignName?.trim()"
          >
            <span *ngIf="!isCreating"> <i class="fa fa-check"></i> Tiếp theo </span>
            <span *ngIf="isCreating"> <i class="fa fa-spinner fa-spin"></i> Đang tạo... </span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MANAGE VIEW -->
  <div class="main-content" *ngIf="viewMode === 'manage'">
    <div class="campaign-management-card">
      <!-- Filter + Search -->
      <div class="filter-search-section">
        <app-select-field
          [options]="filterOptions"
          [(ngModel)]="filterType"
          (valueChange)="onFilterChange()"
          placeholder="Tất cả chiến dịch">
        </app-select-field>

        <div class="search-input-wrapper">
          <input
            type="text"
            class="search-input"
            placeholder="Tìm chiến dịch..."
            [(ngModel)]="searchQuery"
            (keyup.enter)="onSearchCampaigns()"
            (input)="onSearchCampaigns()"
          />
          <i class="fa fa-search search-icon"></i>
        </div>
      </div>

      <div class="results-count">Tìm thấy {{ filteredCampaigns.length }} chiến dịch</div>

      <!-- Loading -->
      <div class="loading-skeleton" *ngIf="loading">
        <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5]"></div>
      </div>

      <!-- Table -->
      <div class="campaigns-table-wrapper" *ngIf="!loading">
        <table class="campaigns-table" *ngIf="filteredCampaigns.length > 0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Chiến dịch</th>
              <th>CV ứng tuyển</th>
              <th>Ngày tạo</th>
              <th>Trạng thái</th>
              <th>Hoạt động</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let campaign of paginatedCampaigns">
              <td class="campaign-id-cell">#{{ campaign.id.slice(-8) }}</td>
              <td class="campaign-info-cell">
                <div class="campaign-name">{{ campaign.name }}</div>
              </td>
              <td class="applied-cvs-cell">
                <span class="applied-cvs-empty">Chưa có CV</span>
              </td>
              <td>{{ formatDate(campaign.creationTime) }}</td>
              <td class="status-cell">
                <span class="status-badge" [class.active]="campaign.isActive">
                  {{ campaign.isActive ? 'Đang hoạt động' : 'Đã tắt' }}
                </span>
              </td>
              <td class="actions-cell">
                <div class="actions-container">
                  <app-toggle-switch
                    [checked]="campaign.isActive"
                    (checkedChange)="onToggleCampaign(campaign, $event)"
                  >
                  </app-toggle-switch>

                  <div class="actions-menu-container" [attr.data-campaign-id]="campaign.id">
                    <button class="actions-btn" (click)="toggleActionsMenu(campaign.id, $event)">
                      <i class="fa fa-ellipsis-h"></i>
                    </button>

                    <div
                      class="actions-menu"
                      [class.show]="showActionsMenu === campaign.id"
                      [style.top.px]="menuPosition?.top"
                      [style.left.px]="menuPosition?.left"
                      [style.max-width.px]="menuPosition?.maxWidth"
                      (click)="$event.stopPropagation()"
                    >
                      <div class="menu-item" (click)="onViewCampaign(campaign)">
                        <i class="fa fa-eye"></i> Xem chi tiết
                      </div>
                      <div class="menu-item" (click)="onViewJobs(campaign)">
                        <i class="fa fa-briefcase"></i> Xem công việc
                      </div>
                      <div class="menu-item" (click)="onEditCampaign(campaign)">
                        <i class="fa fa-edit"></i> Sửa tên
                      </div>
                      <div class="menu-separator"></div>
                      <!-- NÚT MỚI: ĐĂNG TIN TUYỂN DỤNG -->
                      <div class="menu-item post-job-item" (click)="onPostJob(campaign)">
                        <i class="fa fa-plus-circle"></i> Đăng tin tuyển dụng
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="filteredCampaigns.length === 0">
          <i class="fa fa-folder-open empty-icon"></i>
          <p class="empty-message">
            {{ searchQuery || filterType !== 'all' ? 'Không tìm thấy chiến dịch nào' : 'Chưa có
            chiến dịch nào' }}
          </p>
          <p class="empty-submessage" *ngIf="!searchQuery && filterType === 'all'">
            Hãy tạo chiến dịch đầu tiên của bạn
          </p>
        </div>

        <!-- Pagination -->
        <div class="pagination-container" *ngIf="filteredCampaigns.length > itemsPerPage">
          <app-pagination
            [currentPage]="currentPage"
            [totalPages]="totalPages"
            [totalItems]="filteredCampaigns.length"
            [itemsPerPage]="itemsPerPage"
            (pageChange)="onPageChange($event)"
          >
          </app-pagination>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Modal -->
  <app-generic-modal
    [show]="showActivityModal"
    [title]="'Khởi động: ' + campaignForm.campaignName"
    [maxWidth]="'800px'"
    (close)="showActivityModal = false"
  >
    <div class="activity-modal-content text-center py-4">
      <h3>Chiến dịch "{{ campaignForm.campaignName }}" đã được tạo!</h3>
      <p class="text-muted">Bây giờ bạn có thể bắt đầu đăng tin hoặc tìm kiếm ứng viên.</p>
      <div class="mt-4">
        <app-button type="primary" size="large" (click)="onActivityAction()">
          Đăng tin tuyển dụng ngay
        </app-button>
      </div>
    </div>
  </app-generic-modal>

  <!-- Edit Modal -->
  <app-generic-modal
    [show]="showEditModal"
    title="Sửa tên chiến dịch"
    [maxWidth]="'600px'"
    (close)="showEditModal = false"
  >
    <div class="p-4">
      <app-input-field
        label="Tên chiến dịch"
        [(ngModel)]="editCampaignName"
        [error]="editCampaignName.trim() ? '' : 'Tên không được để trống'"
        placeholder="Nhập tên mới"
      >
      </app-input-field>
      <div class="mt-4 text-right">
        <app-button type="secondary" (click)="showEditModal = false">Hủy</app-button>
        <app-button type="primary" class="ml-2" (click)="onSaveEditCampaign()">Lưu</app-button>
      </div>
    </div>
  </app-generic-modal>
</div>