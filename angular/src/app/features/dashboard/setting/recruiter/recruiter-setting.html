<div class="recruiter-setting-page" [class.sidebar-expanded]="sidebarExpanded">
  <!-- Breadcrumb Box -->
  <div class="breadcrumb-box" [class.sidebar-expanded]="sidebarExpanded">
    <div class="breadcrumb-container">
      <span class="breadcrumb-item active">Cài đặt tài khoản</span>
    </div>
  </div>

  <div class="settings-layout">
    <!-- Left Sub-navigation -->
    <div class="left-subnav">
      <nav class="settings-nav">
        <a 
          class="nav-item" 
          [class.active]="activeTab === 'change-password'"
          (click)="setActiveTab('change-password')">
          <i class="fa fa-key nav-icon"></i>
          <span>Đổi mật khẩu</span>
        </a>
        
        <a 
          class="nav-item" 
          [class.active]="activeTab === 'personal-info'"
          (click)="setActiveTab('personal-info')">
          <i class="fa fa-user nav-icon"></i>
          <span>Thông tin cá nhân</span>
        </a>
        
        <a 
          class="nav-item" 
          [class.active]="activeTab === 'business-cert'"
          (click)="setActiveTab('business-cert')">
          <i class="fa fa-file-text nav-icon"></i>
          <span>Giấy đăng ký doanh nghiệp</span>
        </a>
        
        <a 
          class="nav-item" 
          [class.active]="activeTab === 'company-info'"
          (click)="setActiveTab('company-info')">
          <i class="fa fa-building nav-icon"></i>
          <span>Thông tin công ty</span>
        </a>
        
        <a 
          class="nav-item" 
          [class.active]="activeTab === 'api-connection'"
          (click)="setActiveTab('api-connection')">
          <i class="fa fa-plug nav-icon"></i>
          <span>Kết nối API</span>
        </a>
        
        <a 
          class="nav-item" 
          [class.active]="activeTab === 'settings'"
          (click)="setActiveTab('settings')">
          <i class="fa fa-cog nav-icon"></i>
          <span>Cài đặt</span>
        </a>
      </nav>
    </div>

    <!-- Right Content Panel -->
    <div class="right-content" *ngIf="activeTab === 'personal-info'">
      <!-- Account Verification Section -->
      <div class="section-card">
        <div class="section-header">
          <div class="section-title-group">
            <h2 class="section-title">Tài khoản xác thực: {{ verificationLevel }}</h2>
            <p class="section-description">
              Nâng cấp tài khoản lên cấp 2/3 để nhận 100 lượt xem CV ứng viên từ công cụ tìm kiếm CV.
            </p>
          </div>
        <div class="section-progress">
          <div class="progress-meta">
            <span>{{ verificationProgressSteps }} / {{ verificationSteps.length }} bước hoàn thành</span>
            <span>{{ verificationProgress }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="verificationProgress"></div>
          </div>
        </div>
        </div>
        
        <div class="verification-steps">
          <div 
            class="step-item" 
            *ngFor="let step of verificationSteps"
            [class.clickable]="isEmailVerificationStep(step) && !isEmailVerified"
            (click)="onVerificationStepClick(step)">
            <div class="step-radio">
              <input 
                type="radio" 
                [checked]="step.completed" 
                [disabled]="!isEmailVerificationStep(step) || isEmailVerified">
            </div>
            <span class="step-label">{{ step.label }}</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="step-arrow">
              <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
          </div>
        </div>
        
        <div class="section-actions">
          <app-button 
            type="button"
            [size]="'small'"
            (click)="onLearnMore()"
            class="learn-more-btn">
            Tìm hiểu thêm
          </app-button>
        </div>
      </div>

      <!-- Update Personal Information Section -->
      <div class="section-card">
        <h2 class="section-title">Cập nhật thông tin cá nhân</h2>
        
        <div class="form-header-section">
          <div class="avatar-section">
            <app-profile-avatar
              [avatarUrl]="profileData.avatarUrl"
              [name]="profileData.fullName"
              [size]="'large'"
              [showEditButton]="true"
              (onAvatarChange)="onChangeAvatar($event)"
              (onAvatarRemove)="onRemoveAvatar()">
            </app-profile-avatar>
          </div>
          
          <div class="form-group email-group">
            <label class="form-label">Email</label>
            <input 
              type="email" 
              class="form-input" 
              [(ngModel)]="profileData.email"
              name="email"
              required
              readonly>
          </div>
        </div>
        
        <form class="profile-form" (ngSubmit)="onSaveProfile($event)">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Họ và tên</label>
              <input 
                type="text" 
                class="form-input" 
                [(ngModel)]="profileData.fullName"
                name="fullName"
                required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Giới tính</label>
              <select 
                class="form-input" 
                [(ngModel)]="profileData.gender"
                name="gender">
                <option value="male">Nam</option>
                <option value="female">Nữ</option>
                <option value="other">Khác</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Số điện thoại</label>
            <input 
              type="tel" 
              class="form-input" 
              [(ngModel)]="profileData.phone"
              name="phone"
              required>
          </div>

          <div class="form-actions">
            <app-button 
              type="button"
              (click)="onCancel()"
              class="cancel-btn">
              Hủy
            </app-button>
            <app-button 
              type="submit"
              [buttonType]="'submit'"
              [disabled]="isSaving"
              [loading]="isSaving"
              class="save-btn">
              Lưu
            </app-button>
          </div>
        </form>
      </div>
    </div>

    <!-- Change Password Content -->
    <div class="right-content" *ngIf="activeTab === 'change-password'">
      <div class="section-card">
        <h2 class="section-title">Thay đổi mật khẩu</h2>
        
        <!-- Set Password Form for Google Users (First Time) -->
        <form 
          *ngIf="isGoogleUser && !hasPasswordSet"
          [formGroup]="setPasswordForm" 
          (ngSubmit)="onSetPassword($event)" 
          class="change-password-form">
          <!-- Mật khẩu mới -->
          <div class="password-form-row">
            <label class="password-form-label">Mật khẩu mới</label>
            <div class="password-field-wrapper">
              <app-password-field
                formControlName="newPassword"
                [placeholder]="'Nhập mật khẩu mới'"
                [error]="getSetPasswordError('newPassword')"
                [required]="true">
              </app-password-field>
            </div>
          </div>

          <!-- Nhập lại mật khẩu -->
          <div class="password-form-row">
            <label class="password-form-label">Nhập lại mật khẩu</label>
            <div class="password-field-wrapper">
              <app-password-field
                formControlName="confirmPassword"
                [placeholder]="'Nhập lại mật khẩu mới'"
                [error]="getSetPasswordError('confirmPassword')"
                [required]="true">
              </app-password-field>
            </div>
          </div>

          <!-- Form Actions -->
          <app-password-form-actions
            [isSaving]="isSettingPassword"
            [saveText]="'Cập nhật'"
            (cancel)="onCancel()"
            (save)="onSetPassword()">
          </app-password-form-actions>
        </form>

        <!-- Change Password Form (Full Form for Users with Password) -->
        <form 
          *ngIf="!isGoogleUser || hasPasswordSet"
          [formGroup]="changePasswordForm" 
          (ngSubmit)="onChangePassword($event)" 
          class="change-password-form">
          <!-- Mật khẩu hiện tại -->
          <div class="password-form-row">
            <label class="password-form-label">Mật khẩu hiện tại</label>
            <div class="password-field-wrapper">
              <app-password-field
                formControlName="currentPassword"
                [placeholder]="'Nhập mật khẩu hiện tại'"
                [error]="getPasswordError('currentPassword')"
                [required]="true">
              </app-password-field>
            </div>
          </div>

          <!-- Mật khẩu mới -->
          <div class="password-form-row">
            <label class="password-form-label">Mật khẩu mới</label>
            <div class="password-field-wrapper">
              <app-password-field
                formControlName="newPassword"
                [placeholder]="'Nhập mật khẩu mới'"
                [error]="getPasswordError('newPassword')"
                [required]="true">
              </app-password-field>
            </div>
          </div>

          <!-- Nhập lại mật khẩu -->
          <div class="password-form-row">
            <label class="password-form-label">Nhập lại mật khẩu</label>
            <div class="password-field-wrapper">
              <app-password-field
                formControlName="confirmPassword"
                [placeholder]="'Nhập lại mật khẩu mới'"
                [error]="getPasswordError('confirmPassword')"
                [required]="true">
              </app-password-field>
            </div>
          </div>

          <!-- Checkbox: Thoát tất cả các phiên bản đăng nhập hiện tại -->
          <div class="password-form-checkbox">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                [(ngModel)]="logoutAllSessions"
                [ngModelOptions]="{standalone: true}"
                class="checkbox-input">
              <span class="checkbox-text">Thoát tất cả các phiên bản đăng nhập hiện tại</span>
            </label>
          </div>

          <!-- Form Actions -->
          <app-password-form-actions
            [isSaving]="isChangingPassword"
            (cancel)="onCancel()"
            (save)="onChangePassword()">
          </app-password-form-actions>
        </form>
      </div>
    </div>

    <!-- Company Info Content -->
    <div class="right-content" *ngIf="activeTab === 'company-info'">
      <div class="section-card">
        <!-- Show tabs and search/create only if no company selected -->
        <ng-container *ngIf="!selectedCompanyId">
          <!-- Tabs Section -->
          <app-company-tabs 
            [activeTab]="companyTab"
            (tabChange)="setCompanyTab($event)">
          </app-company-tabs>

          <!-- Search Section -->
          <app-search-company
            *ngIf="companyTab === 'search'"
            [searchKeyword]="companySearchKeyword"
            [companyList]="companyList"
            [isSearching]="isSearchingCompany"
            (search)="onSearchCompany($event)"
            (selectCompany)="onSelectCompany($event)">
          </app-search-company>
        </ng-container>

        <!-- Company Detail - Show when company is selected -->
        <div class="company-detail-card" *ngIf="selectedCompanyId && selectedCompanyCard && !isEditingCompany">
          <div class="detail-header">
            <div class="detail-summary">
              <div class="detail-logo" [style.background-color]="selectedCompanyCard.logoBgColor">
                <img *ngIf="selectedCompanyCard.logoImage" [src]="selectedCompanyCard.logoImage" [alt]="selectedCompanyCard.name">
                <span *ngIf="!selectedCompanyCard.logoImage">{{ selectedCompanyCard.logoText }}</span>
              </div>
              <div class="detail-title">
                <h3>{{ selectedCompanyDetail?.companyName || selectedCompanyCard.name }}</h3>
                <p>
                  {{ selectedCompanyDetail?.headquartersAddress || selectedCompanyCard.address }}
                  <span class="dot"></span>
                  {{ selectedCompanyEmployeeRange }}
                </p>
              </div>
            </div>
            <div class="detail-actions">
              <app-button
                type="button"
                [size]="'small'"
                class="outline-btn"
                (click)="onEditSelectedCompany()">
                Chỉnh sửa
              </app-button>
            </div>
          </div>

          <ng-container *ngIf="!isLoadingCompanyDetail; else companyDetailLoading">
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Mã số thuế</span>
                <span class="detail-value">{{ selectedCompanyDetail?.taxCode || selectedCompanyCard.taxId }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Website</span>
                <a class="detail-value link" *ngIf="selectedCompanyDetail?.websiteUrl" [href]="selectedCompanyDetail.websiteUrl" target="_blank" rel="noopener">
                  {{ selectedCompanyDetail.websiteUrl }}
                </a>
                <span class="detail-value" *ngIf="!selectedCompanyDetail?.websiteUrl">Chưa cập nhật</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Lĩnh vực hoạt động</span>
                <span class="detail-value">
                  {{ selectedCompanyCard.tags?.length ? (selectedCompanyCard.tags.join(', ')) : 'Chưa cập nhật' }}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Số điện thoại</span>
                <span class="detail-value">{{ selectedCompanyDetail?.contactPhone || 'Chưa cập nhật' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Email</span>
                <span class="detail-value">{{ selectedCompanyDetail?.contactEmail || selectedCompanyCard.raw?.contactEmail || 'Chưa cập nhật' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Địa chỉ</span>
                <span class="detail-value">{{ selectedCompanyDetail?.headquartersAddress || selectedCompanyCard.address }}</span>
              </div>
            </div>

            <div class="detail-description" *ngIf="selectedCompanyDetail?.description">
              <h4>Giới thiệu công ty</h4>
              <p>{{ selectedCompanyDetail.description }}</p>
            </div>
          </ng-container>

          <ng-template #companyDetailLoading>
            <div class="detail-loading">
              <div class="loading-spinner"></div>
              <p>Đang tải thông tin công ty...</p>
            </div>
          </ng-template>
        </div>

        <!-- Edit Company Form -->
        <div class="company-edit-form" *ngIf="isEditingCompany">
          <div class="editing-banner">
            <div class="editing-text">
              <strong>Đang chỉnh sửa:</strong>
              <span>{{ selectedCompanyDetail?.companyName || selectedCompanyCard?.name }}</span>
            </div>
            <app-button
              type="button"
              [size]="'small'"
              [buttonType]="'secondary'"
              (click)="cancelEditCompany()">
              Hủy
            </app-button>
          </div>
          <app-create-company-form
            [formData]="companyFormData"
            [logoPreview]="companyLogoPreview"
            [formErrors]="companyFormErrors"
            [isSaving]="isSavingCompany"
            [submitLabel]="'Cập nhật thông tin công ty'"
            (logoSelected)="onLogoSelected($event)"
            (fieldValidate)="validateField($event)"
            (save)="onSaveCompany()">
          </app-create-company-form>
        </div>

        <!-- Create Company Section -->
        <app-create-company-form
          *ngIf="companyTab === 'create' && !selectedCompanyId"
          [formData]="companyFormData"
          [logoPreview]="companyLogoPreview"
          [formErrors]="companyFormErrors"
          [isSaving]="isSavingCompany"
          [submitLabel]="'Lưu thông tin công ty'"
          (logoSelected)="onLogoSelected($event)"
          (fieldValidate)="validateField($event)"
          (save)="onSaveCompany()">
        </app-create-company-form>
      </div>
    </div>

    <!-- Settings Content -->
    <div class="right-content" *ngIf="activeTab === 'settings'">
      <div class="section-card">
        <h2 class="section-title">Cài đặt nhận thông báo đến email tài khoản</h2>
        
        <!-- Email Notification Card -->
        <div class="notification-card">
          <div class="notification-icon">
            <i class="fa fa-envelope"></i>
          </div>
          
          <div class="notification-content">
            <div class="notification-header">
              <h3 class="notification-title">Thông báo CV ứng tuyển</h3>
              <span class="notification-status" [class.active]="cvApplicationNotificationEnabled" [class.inactive]="!cvApplicationNotificationEnabled">
                {{ cvApplicationNotificationEnabled ? 'Đang hoạt động' : 'Không hoạt động' }}
              </span>
            </div>
            <p class="notification-description">
              Tự động gửi email khi ứng viên ứng tuyển vào tin tuyển dụng của bạn
            </p>
          </div>
          
          <div class="notification-toggle">
            <label class="toggle-switch">
              <input 
                type="checkbox" 
                [(ngModel)]="cvApplicationNotificationEnabled"
                (change)="onToggleCvApplicationNotification()"
                name="cvApplicationNotification">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Business Cert Content -->
    <div class="right-content" *ngIf="activeTab === 'business-cert'">
      <div class="section-card">
        <app-business-registration
          [documentType]="businessCertDocumentType"
          [selectedFile]="businessCertFile"
          [isSaving]="isSavingBusinessCert"
          [legalStatus]="legalVerificationStatus"
          [documentUrl]="businessCertDocumentUrl"
          [isEditing]="isEditingBusinessCert"
          (documentTypeChange)="onBusinessCertDocumentTypeChange($event)"
          (fileSelected)="onBusinessCertFileSelected($event)"
          (edit)="onEditBusinessCert()"
          (cancel)="onCancelBusinessCert()"
          (save)="onSaveBusinessCert()">
        </app-business-registration>
      </div>
    </div>

    <!-- API Connection Content -->
    <div class="right-content" *ngIf="activeTab === 'api-connection'">
      <div class="section-card">
        <h2 class="section-title">{{ getTabTitle(activeTab) }}</h2>
        <p class="section-description">Chức năng đang được phát triển...</p>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification - Outside container to avoid being clipped -->
<app-toast-notification
  [show]="showToast"
  [message]="toastMessage"
  [type]="toastType"
  (close)="onToastClose()">
</app-toast-notification>

<!-- Email Verification Modal -->
<div class="email-verification-modal" *ngIf="isEmailVerificationModalOpen">
  <div class="modal-backdrop" (click)="closeEmailVerificationModal()"></div>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Xác thực email</h3>
      <button class="close-btn" (click)="closeEmailVerificationModal()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input
          type="email"
          class="form-input"
          [(ngModel)]="emailVerification.email"
          name="verificationEmail">
      </div>

      <div class="form-group">
        <label class="form-label">Mã OTP</label>
        <div class="otp-input-row">
          <input
            type="text"
            class="form-input"
            [(ngModel)]="emailVerification.otp"
            name="verificationOtp"
            maxlength="6">
          <button
            type="button"
            class="otp-send-btn"
            (click)="sendEmailVerificationOtp()"
            [disabled]="emailVerification.isSendingOtp || emailVerification.countdown > 0">
            <ng-container *ngIf="emailVerification.countdown === 0; else countdownTpl">
              {{ emailVerification.isSendingOtp ? 'Đang gửi...' : 'Gửi mã OTP' }}
            </ng-container>
            <ng-template #countdownTpl>
              Gửi lại sau {{ emailVerification.countdown }}s
            </ng-template>
          </button>
        </div>
        <p class="resend-hint">Bạn có thể gửi lại mã OTP sau 1 phút.</p>
      </div>
    </div>

    <div class="modal-footer">
      <app-button type="button" class="cancel-btn" (click)="closeEmailVerificationModal()">
        Hủy
      </app-button>
      <app-button
        type="button"
        class="save-btn"
        [loading]="emailVerification.isVerifying"
        (click)="submitEmailVerification()">
        Xác thực
      </app-button>
    </div>
  </div>
</div>

