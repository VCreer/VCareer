<div class="campaign-job-management-page">
  <!-- Breadcrumb Box -->
  <div class="breadcrumb-box">
    <div class="breadcrumb-container">
      <button class="back-btn" (click)="onBack()">
        <i class="fa fa-arrow-left"></i>
        <span>Quay lại</span>
      </button>
      <h1 class="page-title">{{ campaignName }}</h1>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="search-group">
        <i class="fa fa-search"></i>
        <input
          type="text"
          placeholder="Tìm kiếm công việc..."
          [value]="searchQuery"
          (input)="onSearchChange($any($event.target).value)"
        />
      </div>

      <div class="filter-group">
        <app-status-dropdown
          [options]="statusOptions"
          [selectedValue]="selectedStatus"
          placeholder="Tất cả trạng thái"
          (statusChange)="onStatusChange($event)">
        </app-status-dropdown>
      </div>
    </div>

    <!-- Jobs Table -->
    <div class="jobs-table-container">
      <table class="jobs-table">
        <thead>
          <tr>
            <th>Tiêu đề công việc</th>
            <th>Vị trí</th>
            <th>Địa điểm</th>
            <th>Số CV</th>
            <th>Trạng thái</th>
            <th>Public/Private</th>
            <th>Gói tuyển dụng</th>
            <th>Thao tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let job of paginatedJobs">
            <td class="job-title-cell">
              <div class="job-title-content">
                <div class="job-title">{{ job.title }}</div>
              </div>
            </td>

            <td class="position-cell">
              <span>{{ job.position }}</span>
            </td>

            <td class="location-cell">
              <i class="fa fa-map-marker-alt"></i>
              <span>{{ job.location }}</span>
            </td>

            <td class="cv-count-cell">
              <span>{{ job.appliedCount }}</span>
            </td>

            <td class="status-cell">
              <span class="status-badge" [class]="getStatusClass(job.status)">
                {{ getStatusLabel(job.status) }}
              </span>
            </td>

            <td class="public-cell">
              <span class="public-badge" [class.public]="job.isPublic" [class.private]="!job.isPublic">
                {{ job.isPublic ? 'Public' : 'Private' }}
              </span>
            </td>

            <td class="package-cell">
              <div class="package-badges-container" *ngIf="job.packageTypes && job.packageTypes.length > 0">
                <span 
                  *ngFor="let pkgType of job.packageTypes" 
                  class="package-badge" 
                  [class]="getPackageClass(pkgType)">
                  {{ getPackageLabel(pkgType) }}
                </span>
              </div>
              <span class="package-badge package-empty" *ngIf="!job.packageTypes || job.packageTypes.length === 0">
                Chưa gắn gói
              </span>
            </td>

            <td class="actions-cell">
              <div class="actions-menu-container" [attr.data-job-id]="job.id">
                <button
                  class="actions-btn"
                  type="button"
                  (click)="toggleActionsMenu(job.id, $event)">
                  <i class="fa fa-ellipsis-h"></i>
                </button>
                
                <div
                  class="actions-menu"
                  [class.show]="showActionsMenu === job.id"
                  [style.top.px]="menuPosition?.top"
                  [style.left.px]="menuPosition?.left"
                  [style.max-width.px]="menuPosition?.maxWidth"
                  [attr.data-job-id]="job.id"
                  (click)="$event.stopPropagation()">
                  <div class="menu-item" (click)="onPostJob(job)">
                    <i class="fa fa-paper-plane menu-icon"></i>
                    <span>Đăng bài</span>
                  </div>
                  <div class="menu-separator"></div>
                  <div class="menu-item" (click)="onEditJob(job)">
                    <i class="fa fa-edit menu-icon"></i>
                    <span>Sửa</span>
                  </div>
                  <div class="menu-item" (click)="onViewCVs(job)">
                    <i class="fa fa-file-alt menu-icon"></i>
                    <span>Xem các CV</span>
                  </div>
                  <div class="menu-separator"></div>
                  <div class="menu-item" (click)="onChangeStatusAction(job)">
                    <i class="fa fa-tag menu-icon"></i>
                    <span>Đặt trạng thái</span>
                  </div>
                  <div class="menu-item" (click)="onTogglePublicAction(job)">
                    <i class="fa fa-eye menu-icon"></i>
                    <span>{{ job.isPublic ? 'Đặt Private' : 'Đặt Public' }}</span>
                  </div>
                  <div class="menu-item" (click)="onAssignPackage(job)">
                    <i class="fa fa-gift menu-icon"></i>
                    <span>Gắn gói</span>
                  </div>
                  <div class="menu-separator"></div>
                  <div class="menu-item delete-item" (click)="onDeleteJob(job)">
                    <i class="fa fa-trash menu-icon"></i>
                    <span>Xóa</span>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredJobs.length === 0">
        <div class="empty-state-content">
          <i class="fa fa-briefcase empty-icon"></i>
          <p class="empty-message">
            {{ searchQuery || selectedStatus !== 'all' ? 'Không tìm thấy công việc nào' : 'Chưa có công việc nào' }}
          </p>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="filteredJobs.length > 0">
      <app-pagination
        [currentPage]="currentPage"
        [totalPages]="totalPages"
        [totalItems]="filteredJobs.length"
        [itemsPerPage]="itemsPerPage"
        (pageChange)="onPageChange($event)">
      </app-pagination>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Xác nhận xóa</h3>
        <button class="modal-close" (click)="closeDeleteModal()">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa công việc "<strong>{{ jobToDelete?.title }}</strong>"?</p>
        <p class="warning-text">Hành động này không thể hoàn tác.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteModal()">Hủy</button>
        <button class="btn btn-danger" (click)="confirmDelete()">Xóa</button>
      </div>
    </div>
  </div>

  <!-- Change Status Modal -->
  <div class="modal-overlay" *ngIf="showStatusDropdownModal" (click)="closeStatusModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Đặt trạng thái</h3>
        <button class="modal-close" (click)="closeStatusModal()">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Chọn trạng thái</label>
          <div class="status-dropdown-list">
            <div 
              *ngFor="let status of statusOptions.slice(1)" 
              class="status-option-item"
              [class.active]="selectedStatusValue === status.value"
              (click)="onSelectStatus(status.value)">
              <div class="status-option-content">
                <span class="status-option-label">{{ status.label }}</span>
                <i class="fa fa-check status-check-icon" *ngIf="selectedStatusValue === status.value"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Package Modal -->
  <div class="modal-overlay" *ngIf="showPackageModal" (click)="closePackageModal()">
    <div class="modal-content package-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Gắn gói tuyển dụng</h3>
        <button class="modal-close" (click)="closePackageModal()">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="package-modal-content-wrapper">
          <!-- Loading State -->
          <div *ngIf="isLoadingServices" class="loading-state">
            <i class="fa fa-spinner fa-spin"></i>
            <span>Đang tải danh sách dịch vụ...</span>
          </div>

          <!-- Service Sections grouped by Action -->
          <div *ngIf="!isLoadingServices && serviceSections.length > 0" class="service-sections-container">
            <!-- Loop qua từng section (mỗi action một section) -->
            <div *ngFor="let section of serviceSections; let sectionIndex = index" class="service-section">
              <div class="section-header">
                <div class="section-header-left">
                  <h4 class="section-title">{{ section.label }}</h4>
                  <span class="section-subtitle">Chọn 1 dịch vụ</span>
                </div>
                <div class="section-count-badge">
                  <span class="count-text">{{ section.packages.length }} dịch vụ</span>
                </div>
              </div>
              
              <div class="service-items-grid">
                <div 
                  *ngFor="let service of section.packages; let serviceIndex = index" 
                  class="service-item-card"
                  [class.selected]="isChildServiceSelected(section.action, service.id)"
                  (click)="selectChildService(section.action, service.id)">
                  <div class="service-card-content">
                    <div class="service-card-header">
                      <div class="service-card-title-wrapper">
                        <span class="service-card-name">{{ service.name }}</span>
                        <span class="service-card-number">#{{ serviceIndex + 1 }}</span>
                      </div>
                      <div class="service-radio-wrapper">
                        <div class="radio-button" [class.checked]="isChildServiceSelected(section.action, service.id)">
                          <div class="radio-inner"></div>
                        </div>
                      </div>
                    </div>
                    <p class="service-card-description" *ngIf="service.description">{{ service.description }}</p>
                  </div>
                </div>
              </div>

              <!-- Divider between sections (không hiển thị sau section cuối) -->
              <div *ngIf="sectionIndex < serviceSections.length - 1" class="section-divider"></div>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="!isLoadingServices && serviceSections.length === 0" class="empty-services-state">
            <i class="fa fa-inbox empty-icon"></i>
            <p class="empty-message">Không có dịch vụ nào khả dụng</p>
            <p class="empty-description">Vui lòng thử lại sau hoặc liên hệ hỗ trợ</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-footer-info">
          <i class="fa fa-info-circle"></i>
          <span>Đã chọn: {{ getSelectedChildServiceIds().length }}/{{ serviceSections.length }} dịch vụ</span>
        </div>
        <div class="modal-footer-actions">
          <button class="btn btn-secondary" (click)="closePackageModal()">Hủy</button>
          <button class="btn btn-primary" (click)="confirmAssignPackage()" [disabled]="getSelectedChildServiceIds().length === 0">
            Đăng Công Việc
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <app-toast-notification
    [show]="showToast"
    [message]="toastMessage"
    [type]="toastType"
    (close)="onToastClose()">
  </app-toast-notification>
</div>